name: Build APK Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: WebToApp
  APP_DESCRIPTION: "æ— éœ€ç¼–ç¨‹ï¼Œä¸€é”®å°†ä»»æ„ç½‘ç«™æˆ–åª’ä½“è½¬æ¢ä¸ºç‹¬ç«‹ Android åº”ç”¨ï¼"

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission to gradlew
        run: chmod +x gradlew
        
      - name: Generate keystore
        run: |
          keytool -genkey -v -keystore release.keystore \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias release-key \
            -storepass webtoapp123 \
            -keypass webtoapp123 \
            -dname "CN=WebToApp Build, OU=Test, O=WebToApp, L=China, S=CN, C=CN"
            
      - name: Build debug APK
        run: ./gradlew assembleDebug
        
      - name: Build release APK (signed)
        run: ./gradlew assembleRelease -Pandroid.injected.signing.store.file=$PWD/release.keystore -Pandroid.injected.signing.store.password=webtoapp123 -Pandroid.injected.signing.key.alias=release-key -Pandroid.injected.signing.key.password=webtoapp123
        
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
          VERSION_NUM=${VERSION#v}
          
          # è¯»å– README.md ä¸­çš„åŠŸèƒ½ç‰¹æ€§
          FEATURES=$(sed -n '/## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§/,/## æŠ€æœ¯æ ˆ/p' README.md | head -n -2)
          
          # æ„å»ºå‘å¸ƒè¯´æ˜
          RELEASE_BODY=$(cat <<EOF
          # ğŸ‰ ${APP_NAME} ${VERSION} å‘å¸ƒ
          
          ## ğŸ“ ç®€ä»‹
          ${APP_DESCRIPTION}
          
          **ğŸ”— é¡¹ç›®é“¾æ¥ï¼š** [GitHub ä»“åº“](https://github.com/yingcaihuang/web-to-app)
          
          ## âœ¨ æ­¤ç‰ˆæœ¬åŒ…å«
          - âœ… Debug APKï¼ˆç”¨äºæµ‹è¯•ï¼‰
          - âœ… Release APKï¼ˆå·²ç­¾åï¼Œå¯ç›´æ¥å®‰è£…ï¼‰
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
          3. å¼€å§‹ä½¿ç”¨ WebToApp åˆ›å»ºä½ çš„åº”ç”¨ï¼
          
          ## ğŸ“– åŠŸèƒ½ç‰¹æ€§
          ${FEATURES}
          
          ## ğŸ’¾ å®‰è£…è¯´æ˜
          - **Debug APK**ï¼šç”¨äºå¼€å‘æµ‹è¯•ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯
          - **Release APK**ï¼šç”Ÿäº§ç‰ˆæœ¬ï¼Œå·²ä¼˜åŒ–å’Œç­¾åï¼Œæ¨èä½¿ç”¨
          
          å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ [Issue](https://github.com/yingcaihuang/web-to-app/issues)
          
          ---
          _è‡ªåŠ¨æ„å»ºäº $(date '+%Y-%m-%d %H:%M:%S')_
          EOF
          )
          
          # ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ï¼ˆå¤„ç†å¤šè¡Œæ–‡æœ¬ï¼‰
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_notes.outputs.version }}
          files: |
            app/build/outputs/apk/debug/app-debug.apk
            app/build/outputs/apk/release/app-release.apk
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
